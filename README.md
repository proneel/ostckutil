# ostckutil
License: MIT (https://opensource.org/licenses/MIT)

There are 3 Open Stack utilities in this project.

 1. rsync for Open Stack. A local/NFS directory tree can be automatically cloned to a corresponding pseudo-folder hierarchy in a Swift container. I could find one other project that does this    (http://rclone.org/) which seems to be very comprehensive, but I needed something simpler and custom to my use case.
 2. Bulk delete of objects in Swift. The Swift CLI does not allow deletion of a subset of objects in a container. You may use the swiftbulkdel script from this project to delete a filtered set of objects.
 3. Logging of swift usage. This is a trivial script which logs the list of servers, block storage and Swift containers that your account uses. The objective of this script is to keep a log of usage independent from the Openstack accounting  to check for discrepancies.

## swiftsync ##
As an example, imagine you have a Swift container called music and a hierarchy of music files (objects) arranged into pseudo-folders as shown below.
```
music
--pop
----abracadabra.mp3
----myfavpop.mp3
--rock
----rockingit.mp3
----topofrock
------topofrock1.mp3
and so on
```
You could create this structure on a local/NFS directory and swiftsync will upload files to a corresponding pseudofolder (URL) in the swift container. You could run it in daemon mode (like rsync) and as files are added/modified, swiftsync will PUT to swift. To protect against accidental purge of objects from swift, swiftsync does not delete from the container, even if you delete from local disk.

swiftsync can be run to audit your local versus container to identify discrepancies between the two; the format of the audit is as shown below (with annotations):
```
+ pop/abracadabra.mp3 2a40967f0338272300dc614b05a197d6  ... => indicating this file is in local and not in swift
- rock/topofrock/nolongerahit.mp3 1243ce88295c6e92a8d082fad5c16c3b ...=> indicating this file is in swift and not in local
! rock/thisisgood.mp3 39be796c16676edcf2c279d15ba1681c 2c91b3da5f7ee9ed8a515706c97d4625 ...=> indicating the file is in both, but are different (MD5 sums do not match)
```
Usage (summary), details available by running swiftsync -h
```
swiftsync [-a|authfile=] <auth-path> [-r|--rootdir=] <root-path> [-t|--threads] <num-threads> [-d|--daemon] <interval-time-secs> [-m|--mimepath=] <mime-path> [-c|--ignore-unknown-content-type] [-h|--help] [upload/audit]
```
Other notes:
* Supports multi-threading for parallel uploads. Renaming directories when running upload may cause problems since the threads divide up the directories amongst them based on a hash of the directory path.
* Daemon-mode
* Uses file modification time to decide if the file should be uploaded to swift. Will not kick-in if time on the server is reset to a time past.
* Works well if the objects are organized into pseudo-folders with not more than a few 1000s of objects in a folder. Since multi-threading divvies up directories to each thread, performance will be suboptimal in a flat hierarchy.

Planned Enhancements:
* Allow for file removal by dropping a 'marker' file with a .remove extension in the directory.

## swiftbulkdel ##
swiftbulkdel removes files from a swift container. Typical usage might use a combination of the swift CLI and swiftbulkdel as shown below. Such selective deletion is not available with the swift CLI.
```
swift list music | grep ".*\/indie\/.*mp3" | swiftbulkdel -a auth.txt -c music
```
## ostcklogusage ##
ostcklogusage logs the names and some key information about servers, block storage and swift storage into CSV files. In the use case it was written for, this would be generated once every 3 hours and used to compare with billing generated by the open stack vendor.
```
ostcklogusage /var/log/ostcklogusage auth.txt 
```
